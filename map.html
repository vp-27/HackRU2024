<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Display a map on a webpage</title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
        <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet">
        <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
        <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js'></script>
        <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css' type='text/css' />
        <!-- <script src="events.js"></script> -->

        <style>
            body { margin: 0; padding: 0; }
            #map { position: absolute; top: 0; bottom: 30%; width: 100%; } /* Adjust the bottom value as needed */
            #events-view {
                position: absolute;
                bottom: 0;
                width: 100%;
                height: 30%; /* Adjust as needed */
                overflow: auto;
                background: #f8f8f8; /* Adjust as needed */
            }
            /* Add styles for the events view and tiles */
            
            .event-tile {
                border: 1px solid #ccc; /* Adjust as needed */
                margin: 10px; /* Adjust as needed */
                padding: 10px; /* Adjust as needed */
            }
            .zoom-button { position: absolute; top: 10px; right: 10px; z-index: 1; }
            .marker {
                background-image: url('logo.jpeg');
                background-size: cover;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                
            }
            .eventMarker {
                background-image: url('mapicon.jpeg');
                background-size: cover;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                cursor: pointer;
                
            }
            .pulse {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                background-color: rgba(255, 99, 71, 0.4);
                position: absolute;
                transform: scale(0.5);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% {
                    transform: scale(0.5);
                }
                50% {
                    transform: scale(2);
                }
                100% {
                    transform: scale(0.5);
                }
            }
            .event-tile {
                border: 1px solid #ccc;
                margin: 10px;
                padding: 10px;
                transition: all 0.3s ease-in-out; /* Add transition for smooth hover effect */
            }

            .event-tile:hover {
                border-color: red; /* Change border color on hover */
                box-shadow: 0 0 10px red; /* Add shadow on hover */
                transform: scale(1.02); /* Slightly increase size on hover */
            }
            
        </style>
    </head>
    <body>
        <div id="map"></div>
        <button class="zoom-button" onclick="zoomToUserLocation()">Zoom to My Location</button>
        <div id="events-view"></div> <!-- New events view -->
        <script>

            mapboxgl.accessToken = 'pk.eyJ1IjoiaGVtaXNoIiwiYSI6ImNsdTQ5NWtsOTFmcXMycWs0ZTA0dmQ2NTcifQ.MNt_n-9PjBFBT3k0jCWz-Q';
            const map = new mapboxgl.Map({
                container: 'map', // container ID
                center: [-74.45, 40.52], // starting position [lng, lat]
                zoom: 13 // starting zoom
            });

            let marker;

            let userLocation; // Add this line to declare a global variable for the user's location

            // Get user's current location
            function zoomToUserLocation() {
                // Get the zoom button
                const zoomButton = document.querySelector('.zoom-button');

                if (navigator.geolocation) {
                    const options = {
                        enableHighAccuracy: true,
                        maximumAge: 1000
                    };

                    const successCallback = position => {
                        const { latitude, longitude } = position.coords;

                        userLocation = [longitude, latitude]; // Store the user's location in the global variable

                        // Disable the zoom button
                        zoomButton.disabled = true;

                        // Animate the transition to the user's location
                        map.flyTo({
                            center: [longitude, latitude],
                            zoom: 18,
                            speed: 1,
                            curve: 1,
                            essential: true
                        });

                        // Enable the zoom button once the map has arrived
                        map.once('moveend', () => {
                            zoomButton.disabled = false;
                        });

                        // Remove previous marker if exists
                        if (marker) {
                            marker.remove();
                        }

                        // Create a marker at the user's location
                        marker = new mapboxgl.Marker({
                            element: createMarkerElement(),
                            anchor: 'bottom'
                        })
                            .setLngLat([longitude, latitude])
                            .addTo(map);
                    };

                    const errorCallback = error => {
                        console.error(error);
                    };

                    // Get the user's current position
                    navigator.geolocation.getCurrentPosition(successCallback, errorCallback, options);
                } else {
                    console.error('Geolocation is not supported by this browser.');
                }
            }

            // New mapbox directions object
            const directions = new MapboxDirections({
                accessToken: mapboxgl.accessToken,
                unit: 'metric',
                profile: 'mapbox/walking',
                interactive: false // Disable the click event listener
            });
            map.addControl(directions, 'top-left');

            // Add a custom event listener for the dblclick event
            map.on('dblclick', function(e) {
                // Check if userLocation is available
                if (userLocation) {
                    // Set the origin and destination of the directions
                    directions.setOrigin(userLocation);
                    directions.setDestination(e.lngLat);
                } else {
                    // If userLocation is not available, add a marker at the clicked location
                    new mapboxgl.Marker()
                        .setLngLat(e.lngLat)
                        .addTo(map);
                }
            });
            // This double click portion may not wrok



            // Create a custom marker element
            function createMarkerElement() {
                const markerElement = document.createElement('div');
                markerElement.className = 'marker';
                

                // Create a child div for the pulsating effect
                const pulseElement = document.createElement('div');
                pulseElement.className = 'pulse';
                markerElement.appendChild(pulseElement);

                return markerElement;
            }

            function createEventMarkerElement() {
                const markerElement = document.createElement('div');
                markerElement.className = 'eventMarker';
                return markerElement;
            }
            // Where the event data is stored
            let events = [
                {
                    name: 'Event 1',
                    description: 'Description for event 1',
                    date: '2024-03-23',
                    address: '123 Main St, Piscataway, NJ',
                    coordinates: [-74.45, 40.52] // longitude, latitude
                },
                // more events...
                {
                    name: 'Event 2',
                    description: 'Description for event 1',
                    date: '2024-03-21',
                    address: '123 Main St, Piscataway, NJ',
                    coordinates: [-74.5, 40.6] // longitude, latitude
                },
            ];

            // Function to create an event tile
            function createEventTile(event) {
                const tile = document.createElement('div');
                tile.className = 'event-tile';
                tile.innerHTML = `
                    <h2>${event.name}</h2>
                    <p>${event.description}</p>
                    <p>Date: ${event.date}</p>
                    <p>Address: ${event.address}</p>
                `;

                // Add an event listener to the tile
                tile.addEventListener('click', () => {
                    // Check if userLocation is available
                    if (userLocation) {
                        // Set the origin and destination of the directions
                        directions.setOrigin(userLocation);
                        directions.setDestination(event.coordinates);
                    } else {
                        // If userLocation is not available, zoom to the event's location
                        map.flyTo({
                            center: event.coordinates,
                            zoom: 18,
                            speed: 1,
                            curve: 1,
                            essential: true
                        });
                    }
                });

                return tile;
            }


            // Sort events by date
            events.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Add tiles to the events view
            const eventsView = document.getElementById('events-view');
            events.forEach(event => {
                const tile = createEventTile(event);
                eventsView.appendChild(tile);
            });

            // Add markers to the map for each event
            // add markers for each event, use the new function:
            map.on('load', function() {
                events.forEach(event => {
                    const markerElement = createEventMarkerElement();
                    
                    // Add event listener to the marker element
                    markerElement.addEventListener('click', () => {
                        if (userLocation) {
                            // Set the origin and destination of the directions
                            directions.setOrigin(userLocation);
                            directions.setDestination(event.coordinates);
                        } else {
                            // If userLocation is not available, zoom to the event's location
                            map.flyTo({
                                center: event.coordinates,
                                zoom: 18,
                                speed: 1,
                                curve: 1,
                                essential: true
                            });
                        }
                    });

                    // Create a new marker with the custom element
                    const marker = new mapboxgl.Marker(markerElement)
                        .setLngLat(event.coordinates)
                        .addTo(map);
                });
            });


        </script>
    </body>
</html>
</div>

